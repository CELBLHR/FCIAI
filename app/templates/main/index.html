{% extends "main/base_layout.html" %}

{% block title %}PPTç¿»è¯‘{% endblock %}

{% block styles %}
<style>
.main-content {
    display: flex;
    gap: 2rem;
}

.upload-section {
    flex: 1;
}

.history-section {
    width: 390px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 1.5rem;
}

.upload-container {
    background: rgba(0, 0, 0, 0.2);
    border: 2px dashed rgba(0, 168, 255, 0.3);
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    transition: border-color 0.3s;
    cursor: pointer;
}

.upload-container.dragover {
    border-color: var(--primary-color);
    background: rgba(0, 168, 255, 0.1);
}

.upload-container p {
    margin-bottom: 1rem;
    color: var(--text-color);
}

.upload-container input[type="file"] {
    display: none;
}

.selected-file {
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 5px;
    display: none;
}

.loading-container {
    margin-top: 2rem;
    text-align: center;
    display: none;
}

.progress-message {
    margin-top: 1rem;
    color: var(--text-color);
    font-size: 1rem;
}

/* å†å²è®°å½•æ ·å¼ */
.history-list {
    margin-top: 1rem;
}

.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.history-item:hover {
    background: rgba(255, 255, 255, 0.1);
}

.file-info {
    flex: 1;
    min-width: 0;
    margin-right: 12px;
}

.file-name {
    font-size: 1rem;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text-color);
}

.file-meta {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.6);
    display: flex;
    gap: 8px;
}

.history-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}

.history-actions button {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.history-actions button i {
    margin-right: 3px;
    font-size: 0.9rem;
}

.download-btn {
    background-color: #0d6efd !important;
    color: #ffffff !important;
}

.download-btn:hover {
    background-color: #0b5ed7 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.delete-btn {
    background-color: #dc3545 !important;
    color: #ffffff !important;
}

.delete-btn:hover {
    background-color: #bb2d3b !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* ç®¡ç†å‘˜å·¥å…·æ  */
.admin-tools {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.admin-tools h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: var(--primary-color);
    font-size: 1.1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 8px;
}

.admin-tools-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.admin-tool-btn {
    background: rgba(0, 168, 255, 0.2);
    border: 1px solid var(--primary-color);
    border-radius: 5px;
    padding: 8px 12px;
    color: var(--text-color);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.admin-tool-btn:hover {
    background: rgba(0, 168, 255, 0.3);
    transform: translateY(-1px);
}

.admin-tool-btn i {
    font-size: 0.9rem;
}

/* Loading spinner */
.sk-chase {
    width: 40px;
    height: 40px;
    position: relative;
    animation: sk-chase 2.5s infinite linear both;
    margin: 0 auto;
}

.sk-chase-dot {
    width: 100%;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
    animation: sk-chase-dot 2.0s infinite ease-in-out both;
}

.sk-chase-dot:before {
    content: '';
    display: block;
    width: 25%;
    height: 25%;
    background-color: var(--primary-color);
    border-radius: 100%;
    animation: sk-chase-dot-before 2.0s infinite ease-in-out both;
}

@keyframes sk-chase {
    100% { transform: rotate(360deg); }
}

@keyframes sk-chase-dot {
    80%, 100% { transform: rotate(360deg); }
}

@keyframes sk-chase-dot-before {
    50% {
        transform: scale(0.4);
    }
    100%, 0% {
        transform: scale(1.0);
    }
}

.status-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    font-size: 0.8rem;
}

.status-badge.success {
    background-color: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.status-badge.pending {
    background-color: rgba(255, 193, 7, 0.2);
    color: #ffc107;
}

.history-item-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.history-item-actions button {
    padding: 0.5rem;
    font-size: 1rem;
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    transition: color 0.3s;
}

.history-item-actions button:hover {
    color: var(--primary-color);
}

.history-container {
    max-height: 510px;
    overflow-y: auto;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
}

/* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ */
.history-container::-webkit-scrollbar {
    width: 6px;
}

.history-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.history-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.history-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.annotation-select {
    position: fixed;
    top: 80px;
    right: 20px;
   background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 8px;
    z-index: 1000;
    min-width: 200px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.annotation-select select {
    width: 100%;
    padding: 8px;
    border: 1px solid rgba(0, 168, 255, 0.3);
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.2);
    color: var(--text-color);
}

.annotation-select label {
    display: block;
    margin-bottom: 5px;
    color: var(--text-color);
    font-size: 0.9rem;
}

#queue-status {
    margin-top: 15px;
    padding: 10px 15px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.spinner-border {
    width: 1rem;
    height: 1rem;
}

.loading-spinner {
    display: inline-block;
    width: 50px;
    height: 50px;
    border: 3px solid rgba(0, 123, 255, 0.3);
    border-radius: 50%;
    border-top-color: #007bff;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.loading-text {
    color: #666;
    margin-top: 10px;
    font-size: 14px;
}

/* æ·»åŠ è¿›åº¦æ¡æ ·å¼ */
.progress-container {
    margin-top: 1rem;
    display: none;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    min-height: 200px;
    width: 100%;
    box-sizing: border-box;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.progress-bar-container {
    width: 100%;
    height: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: var(--primary-color);
    width: 0;
    transition: width 0.3s;
}

.slide-info {
    color: var(--text-color);
    font-size: 0.9rem;
}

.progress-percentage {
    color: var(--text-color);
    font-size: 0.9rem;
}

/* é¡µé¢é€‰æ‹©æ‚¬æµ®æ  */
.page-selector {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.8);
    border-radius: 10px;
    padding: 1rem;
    width: 250px;
    max-height: 80vh;
    overflow-y: auto;
    color: var(--text-color);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 1000;
}

.page-selector-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.page-selector-title {
    font-size: 1rem;
    font-weight: bold;
}

.page-selector-actions {
    display: flex;
    gap: 0.5rem;
}

.page-selector-actions button {
    padding: 0.3rem 0.6rem;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
}

.select-all-btn {
    background: var(--primary-color);
    color: white;
}

.deselect-all-btn {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-color);
}

.page-list {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.page-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    padding: 0.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

.page-item.selected {
    background: var(--primary-color);
    color: white;
}

.page-item:hover {
    background: var(--primary-color);
    color: white;
}

.translate-actions {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
}

.start-translate-btn {
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 0.8rem 2rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.start-translate-btn:hover {
    background: #218838;
    transform: translateY(-1px);
}

.start-translate-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

/* ç¾åŒ–æ»šåŠ¨æ¡ */
.page-selector::-webkit-scrollbar {
    width: 6px;
}

.page-selector::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.page-selector::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}

.page-selector::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* è¯¦ç»†çŠ¶æ€æ˜¾ç¤ºæ ·å¼ */
.detailed-status {
    margin-top: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    overflow: hidden;
}

.status-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    background: rgba(0, 0, 0, 0.3);
}

.status-header h4 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-color);
}

.toggle-detail-btn {
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}

.toggle-detail-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.detail-content {
    padding: 1rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.detail-content.expanded {
    max-height: 300px;
    overflow-y: auto;
}

.status-section {
    display: flex;
    margin-bottom: 0.5rem;
}

.status-label {
    width: 100px;
    font-weight: bold;
    color: var(--text-color);
}

.status-value {
    flex: 1;
    color: var(--primary-color);
}

.log-container {
    margin-top: 1rem;
}

.log-header {
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.translation-log {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    padding: 0.5rem;
    max-height: 150px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.85rem;
    color: #ddd;
}

.log-entry {
    margin-bottom: 0.3rem;
    border-left: 3px solid var(--primary-color);
    padding-left: 0.5rem;
    word-break: break-word;
}

.log-entry.error {
    border-left-color: #dc3545;
}

.log-entry.warning {
    border-left-color: #ffc107;
}

.log-entry.success {
    border-left-color: #28a745;
}

.log-timestamp {
    color: #999;
    margin-right: 0.5rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1><i class="bi bi-translate"></i> PPTæ–‡ä»¶ç¿»è¯‘å·¥å…·</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('main.pdf_annotate') }}" class="btn btn-secondary" style="text-decoration: none; padding: 0.5rem 1rem; border-radius: 5px; background: rgba(0, 168, 255, 0.2); color: var(--text-color); border: 1px solid var(--primary-color); transition: all 0.3s ease;">
            <i class="bi bi-file-pdf"></i> PDFæ³¨é‡Šå·¥å…·
        </a>
        <a href="{{ url_for('auth.logout') }}" class="btn btn-outline" style="text-decoration: none; padding: 0.5rem 1rem; border-radius: 5px; background: rgba(255, 0, 0, 0.1); color: #ff6b6b; border: 1px solid #ff6b6b; transition: all 0.3s ease;">
            <i class="bi bi-box-arrow-right"></i> é€€å‡ºç™»å½•
        </a>
    </div>
</div>

<div class="annotation-select">
   <div>
        <label for="source-language">æºè¯­è¨€</label>
        <select id="source-language">
            <option value="English">è‹±è¯­</option>
            <option value="Chinese">ä¸­æ–‡</option>
            <option value="Dutch">è·å…°è¯­</option>
        </select>
    </div>
    <div>
        <label for="target-language">ç›®æ ‡è¯­è¨€</label>
        <select id="target-language">
            <option value="Chinese">ä¸­æ–‡</option>
            <option value="English">è‹±è¯­</option>
            <option value="Dutch">è·å…°è¯­</option>
        </select>
    </div>
    <div>
        <label for="annotation-file">æ³¨é‡Šæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
        <select id="annotation-file">
            <option value="">ä¸ä½¿ç”¨æ³¨é‡Šæ–‡ä»¶</option>
        </select>
    </div>
    <div>
        <label for="bilingual_translation">æ˜¯å¦ä¿ç•™æºè¯­è¨€</label>
        <select id="bilingual_translation">
            <option value="1">ä¿ç•™æºè¯­è¨€</option>
            <option value="0">ä¸ä¿ç•™æºè¯­è¨€</option>
        </select>
    </div>
    <div>
        <label for="model">ç¿»è¯‘æ¨¡å‹</label>
        <select id="model">
            <option value="qwen">Qwen2.5</option>
            <option value="deepseek">DeepSeek-Chat</option>
        </select>
    </div>
</div>

<div id="queue-status" class="alert alert-info" style="display: none;">
    <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden"></span>
    </div>
    <span id="queue-message"></span>
</div>

<div class="main-content">
    <div class="upload-section">
        {% if current_user.is_admin %}
        <div class="admin-tools">
            <h3>ç®¡ç†å‘˜å·¥å…·</h3>
            <div class="admin-tools-list">
                <a href="{{ url_for('db_management.db_stats_page') }}" class="admin-tool-btn">
                    <i class="fas fa-database"></i> æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
                </a>
                <a href="{{ url_for('main.monitor') }}" class="admin-tool-btn">
                    <i class="fas fa-chart-line"></i> ç³»ç»Ÿç›‘æ§
                </a>
                <a href="{{ url_for('main.logs') }}" class="admin-tool-btn">
                    <i class="fas fa-file-alt"></i> ç³»ç»Ÿæ—¥å¿—
                </a>
            </div>
        </div>
        {% endif %}

        <h2>PPTç¿»è¯‘</h2>
        <div class="upload-container" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <p>æ‹–æ‹½PPTæ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
            <input type="file" id="fileInput" accept=".ppt,.pptx" style="display: none;">
            <button class="btn btn-primary">
                <i class="fas fa-upload"></i>
                ä¸Šä¼ PPTæ–‡ä»¶
            </button>
            <div class="loading-container" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text">åŠ è½½ä¸­...</div>
            </div>
            <div id="progressContainer" class="progress-container">
                <div class="progress-info">
                    <div class="slide-info">
                        æ­£åœ¨ç¿»è¯‘ç¬¬ <span id="currentSlide">0</span> é¡µï¼Œå…± <span id="totalSlides">0</span> é¡µ
                    </div>
                    <div class="progress-percentage">
                        <span id="progressText">0%</span>
                    </div>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBarFill" class="progress-bar-fill"></div>
                </div>

                <!-- æ·»åŠ è¯¦ç»†çš„ç¿»è¯‘çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="detailedStatus" class="detailed-status">
                    <div class="status-header">
                        <h4>ç¿»è¯‘è¯¦æƒ…</h4>
                        <button id="toggleDetailBtn" class="toggle-detail-btn" onclick="toggleDetailView()">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div id="detailContent" class="detail-content">
                        <div class="status-section">
                            <div class="status-label">å½“å‰é˜¶æ®µ:</div>
                            <div id="currentStage" class="status-value">ç­‰å¾…å¼€å§‹</div>
                        </div>
                        <div class="status-section">
                            <div class="status-label">å½“å‰æ“ä½œ:</div>
                            <div id="currentOperation" class="status-value">-</div>
                        </div>
                        <div class="log-container">
                            <div class="log-header">å¤„ç†æ—¥å¿—:</div>
                            <div id="translationLog" class="translation-log"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="history-section">
        <h3>å†å²è®°å½•</h3>
        <div class="history-container" id="historyContainer">
            <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</div>

<!-- é¡µé¢é€‰æ‹©æ‚¬æµ®æ  -->
<div id="pageSelector" class="page-selector">
    <div class="page-selector-header">
        <div class="page-selector-title">é€‰æ‹©è¦ç¿»è¯‘çš„é¡µé¢</div>
        <div class="page-selector-actions">
            <button class="select-all-btn" onclick="selectAllPages()">
                <i class="fas fa-check-double"></i> å…¨é€‰
            </button>
            <button class="deselect-all-btn" onclick="deselectAllPages()">
                <i class="fas fa-times"></i> å–æ¶ˆ
            </button>
        </div>
    </div>
    <div id="pageList" class="page-list">
        <!-- é¡µé¢åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div class="translate-actions">
        <button id="startTranslateBtn" class="start-translate-btn" onclick="startTranslation()" disabled>
            <i class="fas fa-language"></i>
            å¼€å§‹ç¿»è¯‘
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedAnnotationFile = null;
let uploadedFile = null;
let selectedPages = new Set();
let totalPageCount = 0;
let sourceLanguage = 'en';
let targetLanguage = 'zh';
let bilingual_translation=1
let model = 'qwen';
// ç›‘å¬è¯­è¨€é€‰æ‹©å˜åŒ–
document.getElementById('source-language').addEventListener('change', function(e) {
    sourceLanguage = e.target.value;
});

document.getElementById('target-language').addEventListener('change', function(e) {
    targetLanguage = e.target.value;
});
document.getElementById('bilingual_translation').addEventListener('change', function(e) {
    bilingual_translation = e.target.value;
});
document.getElementById('model').addEventListener('change', function(e) {
    model = e.target.value;
});
// åŠ è½½ç”¨æˆ·çš„æ³¨é‡Šæ–‡ä»¶åˆ—è¡¨
async function loadAnnotationFiles() {
    try {
        const response = await fetch('/get_annotation_files');
        if (!response.ok) {
            throw new Error('è·å–æ³¨é‡Šæ–‡ä»¶åˆ—è¡¨å¤±è´¥');
        }
        const files = await response.json();

        const select = document.getElementById('annotation-file');
        select.innerHTML = '<option value="">ä¸ä½¿ç”¨æ³¨é‡Šæ–‡ä»¶</option>';

        files.forEach(file => {
            const option = document.createElement('option');
            option.value = file.filename;
            option.textContent = file.filename;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading annotation files:', error);
        showToast('åŠ è½½æ³¨é‡Šæ–‡ä»¶åˆ—è¡¨å¤±è´¥', 'error');
    }
}

// ç›‘å¬æ³¨é‡Šæ–‡ä»¶é€‰æ‹©å˜åŒ–
document.getElementById('annotation-file').addEventListener('change', function(e) {
    selectedAnnotationFile = e.target.value;
});

// æ–‡ä»¶æ‹–æ”¾å¤„ç†
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const pageSelector = document.getElementById('pageSelector');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add('dragover');
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('dragover');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

async function handleFile(file) {
    if (!file.name.match(/\.(ppt|pptx)$/i)) {
        showToast('è¯·é€‰æ‹©PPTæ–‡ä»¶(.pptæˆ–.pptxæ ¼å¼)', 'error');
        return;
    }

    uploadedFile = file;

    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.querySelector('.loading-container').style.display = 'block';

        // ä½¿ç”¨ pptx.js è·å–é¡µæ•°
        const arrayBuffer = await file.arrayBuffer();
        const pptx = await JSZip.loadAsync(arrayBuffer);
        const slideFiles = Object.keys(pptx.files).filter(name => name.startsWith('ppt/slides/slide'));
        totalPageCount = slideFiles.length;

        // ç”Ÿæˆé¡µé¢é€‰æ‹©åˆ—è¡¨
        generatePageList(totalPageCount);

        // æ˜¾ç¤ºé¡µé¢é€‰æ‹©å™¨
        pageSelector.style.display = 'block';

        // é»˜è®¤å…¨é€‰
        selectAllPages();

        // éšè—åŠ è½½çŠ¶æ€
        document.querySelector('.loading-container').style.display = 'none';

        showToast('æ–‡ä»¶å·²å‡†å¤‡å¥½ï¼Œè¯·é€‰æ‹©è¦ç¿»è¯‘çš„é¡µé¢', 'success');
    } catch (error) {
        console.error('Error processing file:', error);
        document.querySelector('.loading-container').style.display = 'none';
        showToast('æ–‡ä»¶å¤„ç†å¤±è´¥', 'error');
    }
}

function generatePageList(pageCount) {
    const pageList = document.getElementById('pageList');
    pageList.innerHTML = '';

    for (let i = 1; i <= pageCount; i++) {
        const pageItem = document.createElement('div');
        pageItem.className = 'page-item';
        pageItem.textContent = i;
        pageItem.dataset.page = i;

        pageItem.addEventListener('click', () => togglePage(i, pageItem));

        pageList.appendChild(pageItem);
    }
}

function togglePage(pageNum, element) {
    if (selectedPages.has(pageNum)) {
        selectedPages.delete(pageNum);
        element.classList.remove('selected');
    } else {
        selectedPages.add(pageNum);
        element.classList.add('selected');
    }

    updateStartButton();
}

function selectAllPages() {
    selectedPages.clear();
    const pageItems = document.querySelectorAll('.page-item');
    pageItems.forEach(item => {
        const pageNum = parseInt(item.dataset.page);
        selectedPages.add(pageNum);
        item.classList.add('selected');
    });
    updateStartButton();
}

function deselectAllPages() {
    selectedPages.clear();
    const pageItems = document.querySelectorAll('.page-item');
    pageItems.forEach(item => {
        item.classList.remove('selected');
    });
    updateStartButton();
}

function updateStartButton() {
    const startButton = document.getElementById('startTranslateBtn');
    startButton.disabled = selectedPages.size === 0;
}

async function startTranslation() {
    if (!uploadedFile || selectedPages.size === 0) {
        showToast('è¯·é€‰æ‹©è¦ç¿»è¯‘çš„é¡µé¢', 'error');
        return;
    }

    try {
        // é¦–å…ˆä¸Šä¼ æ–‡ä»¶
        const formData = new FormData();
        formData.append('file', uploadedFile);
        formData.append('source_language', sourceLanguage);
        formData.append('target_language', targetLanguage);
        formData.append('bilingual_translation',bilingual_translation)
        formData.append('model',model)
        if (selectedAnnotationFile) {
            formData.append('annotation_filename', selectedAnnotationFile);
        }
        formData.append("select_page", Array.from(selectedPages).join(','));
        const uploadResponse = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        if (!uploadResponse.ok) {
            const data = await uploadResponse.json();
            throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
        }

        // const uploadData = await uploadResponse.json();
        // å¼€å§‹ç¿»è¯‘ä»»åŠ¡
        // const response = await fetch('/start_translation', {
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json'
        //     },
        //     body: JSON.stringify({
        //         file_path: uploadData.file_path,
        //         pages: Array.from(selectedPages),
        //         annotation_filename: selectedAnnotationFile
        //     })
        // });
        // const result = await response.json();

        if (uploadResponse.ok) {
            // éšè—é¡µé¢é€‰æ‹©å™¨
            pageSelector.style.display = 'none';

            // æ˜¾ç¤ºè¿›åº¦å®¹å™¨
            const progressContainer = document.getElementById('progressContainer');
            const statusDiv = document.getElementById('queue-status');
            progressContainer.style.display = 'block';
            statusDiv.style.display = 'block';

            // ğŸ”§ æ¸…ç†ä¹‹å‰çš„æ—¥å¿—å’ŒçŠ¶æ€
            const translationLog = document.getElementById('translationLog');
            if (translationLog) {
                translationLog.innerHTML = ''; // æ¸…ç©ºä¹‹å‰çš„æ—¥å¿—
            }

            // é‡ç½®æ—¥å¿—ç›¸å…³çš„å…¨å±€å˜é‡
            window.lastLoggedSlide = null;
            window.loggedMessages = {};
            window.lastLogTimestamp = null;

            // æ¸…ç†è¿›åº¦ç›¸å…³çš„å…¨å±€å˜é‡
            for (let key in window) {
                if (key.startsWith('logged_')) {
                    delete window[key];
                }
            }

            // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤º
            document.getElementById('currentSlide').textContent = '0';
            document.getElementById('totalSlides').textContent = totalPageCount;
            document.getElementById('progressBarFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('queue-message').textContent = 'æ­£åœ¨å‡†å¤‡ç¿»è¯‘...';

            // è®¾ç½®ç¿»è¯‘çŠ¶æ€æ ‡å¿—ï¼Œé˜²æ­¢è¿›åº¦å®¹å™¨è¢«æ„å¤–éšè—
            window.isTranslationActive = true;

            // æ·»åŠ æ–°ä»»åŠ¡å¼€å§‹çš„æ—¥å¿—
            if (translationLog) {
                addLogEntry(translationLog, "å¼€å§‹æ–°çš„ç¿»è¯‘ä»»åŠ¡...", "info");
                // ğŸ”§ æ˜¾ç¤ºé€‰æ‹©çš„é¡µé¢ä¿¡æ¯
                const selectedPagesArray = Array.from(selectedPages).sort((a, b) => a - b);
                addLogEntry(translationLog, `é€‰æ‹©ç¿»è¯‘é¡µé¢: ${selectedPagesArray.join(', ')} (å…±${selectedPagesArray.length}é¡µ)`, "info");
            }

            // å¼€å§‹å®šæœŸæ£€æŸ¥ä»»åŠ¡çŠ¶æ€ - æ”¹ä¸º2ç§’æé«˜å“åº”æ€§
            if (window.statusCheckInterval) {
                clearInterval(window.statusCheckInterval);
            }
            window.statusCheckInterval = setInterval(checkTaskStatus, 2000); // æ”¹ä¸º2ç§’

            // å»¶è¿Ÿæ£€æŸ¥çŠ¶æ€ï¼Œç»™æœåŠ¡å™¨æ—¶é—´å¤„ç†ä»»åŠ¡
            setTimeout(() => {
                checkTaskStatus();
            }, 1000); // 1ç§’åå¼€å§‹æ£€æŸ¥

            showToast('ç¿»è¯‘ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨å¤„ç†ä¸­...', 'success');
        }
    } catch (error) {
        showErrorMessage(error.message);
    }
}

function loadHistory(force = false) {
    // é¿å…é¢‘ç¹åˆ·æ–°å†å²è®°å½•ï¼Œé™¤éå¼ºåˆ¶åˆ·æ–°
    const now = Date.now();
    if (!force && window.lastHistoryLoad && (now - window.lastHistoryLoad) < 10000) {
        return; // 10ç§’å†…ä¸é‡å¤åŠ è½½
    }

    window.lastHistoryLoad = now;

    fetch('/history')
        .then(response => response.json())
        .then(records => {
            const historyContainer = document.getElementById('historyContainer');
            if (!historyContainer) return;

            historyContainer.innerHTML = records.map(record => `
                <div class="history-item">
                    <div class="file-info">
                        <div class="file-name" title="${record.filename}">
                            ${record.filename}
                        </div>
                        <div class="file-meta">
                            <span class="upload-time">${formatDateTime(record.upload_time)}</span>
                            <span class="file-size">${formatFileSize(record.file_size)}</span>
                        </div>
                    </div>
                    <div class="history-actions">
                        ${record.file_exists ?
                            `<button class="download-btn" onclick="downloadFile(${record.id})" title="ä¸‹è½½æ–‡ä»¶">
                                <i class="fas fa-download"></i>ä¸‹è½½
                            </button>` : ''
                        }
                        <button class="delete-btn" onclick="deleteFile(${record.id})" title="åˆ é™¤æ–‡ä»¶">
                            <i class="fas fa-trash-alt"></i>åˆ é™¤
                        </button>
                    </div>
                </div>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading history:', error);
            showErrorMessage('åŠ è½½å†å²è®°å½•å¤±è´¥');
        });
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    
    try {
        // å°†å­—ç¬¦ä¸²è§£æä¸ºæ—¥æœŸå¯¹è±¡
        // æœåŠ¡å™¨è¿”å›çš„æ—¶é—´å·²ç»æ˜¯æ­£ç¡®çš„æ—¶åŒºæ ¼å¼ï¼Œä½†JavaScriptä¼šè‡ªåŠ¨è½¬ä¸ºæœ¬åœ°æ—¶åŒº
        // æ­¤å¤„ç¡®ä¿æ­£ç¡®å¤„ç†æ—¶åŒºé—®é¢˜
        const date = new Date(dateTimeStr);
        
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(date.getTime())) {
            return dateTimeStr; // å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
        }
        
        // ä½¿ç”¨ä¸­å›½æ—¶åŒºæ ¼å¼åŒ–æ˜¾ç¤º
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false // ä½¿ç”¨24å°æ—¶åˆ¶
        });
    } catch (e) {
        console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', e);
        return dateTimeStr; // å‘ç”Ÿé”™è¯¯æ—¶è¿”å›åŸå§‹å­—ç¬¦ä¸²
    }
}

function downloadFile(recordId) {
    window.location.href = `/download/${recordId}`;
}

function deleteFile(recordId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;

    fetch(`/delete/${recordId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        showSuccessMessage('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
        loadHistory(true); // åˆ é™¤åå¼ºåˆ¶åˆ·æ–°
    })
    .catch(error => {
        showErrorMessage(error.message);
    });
}

function showSuccessMessage(message) {
    alert(message);
}

function showErrorMessage(message) {
    alert(message);
}

// åˆå§‹åŠ è½½å†å²è®°å½•
loadHistory();

// åˆå§‹åŠ è½½æ³¨é‡Šæ–‡ä»¶åˆ—è¡¨
loadAnnotationFiles();

// ä¿®æ”¹æ£€æŸ¥ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°
function checkTaskStatus() {
    fetch('/task_status')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            var statusDiv = document.getElementById('queue-status');
            var messageSpan = document.getElementById('queue-message');
            var loadingContainer = document.querySelector('.loading-container');
            var progressContainer = document.getElementById('progressContainer');
            var detailContent = document.getElementById('detailContent');
            var currentStage = document.getElementById('currentStage');
            var currentOperation = document.getElementById('currentOperation');
            var translationLog = document.getElementById('translationLog');

            if (data.status === 'no_task') {
                // å¦‚æœç¿»è¯‘åˆšåˆšå¯åŠ¨ï¼Œä¸è¦ç«‹å³éšè—è¿›åº¦å®¹å™¨
                if (window.isTranslationActive) {
                    // ä¿æŒè¿›åº¦å®¹å™¨æ˜¾ç¤ºï¼Œæ˜¾ç¤ºç­‰å¾…çŠ¶æ€
                    statusDiv.style.display = 'block';
                    progressContainer.style.display = 'block';
                    messageSpan.textContent = 'æ­£åœ¨å‡†å¤‡ç¿»è¯‘ä»»åŠ¡...';

                    // å¢åŠ ç­‰å¾…è®¡æ•°å™¨
                    if (!window.waitingCount) window.waitingCount = 0;
                    window.waitingCount++;

                    // å¦‚æœç­‰å¾…è¶…è¿‡30ç§’ï¼ˆ15æ¬¡æ£€æŸ¥ï¼‰ï¼Œè®¤ä¸ºä»»åŠ¡å¯èƒ½å¤±è´¥
                    if (window.waitingCount > 15) {
                        window.isTranslationActive = false;
                        window.waitingCount = 0;
                        statusDiv.style.display = 'none';
                        progressContainer.style.display = 'none';
                        showToast('ç¿»è¯‘ä»»åŠ¡å¯åŠ¨è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');

                        if (window.statusCheckInterval) {
                            clearInterval(window.statusCheckInterval);
                            window.statusCheckInterval = null;
                        }
                    }
                    return;
                } else {
                    // æ­£å¸¸æƒ…å†µä¸‹éšè—è¿›åº¦å®¹å™¨
                    statusDiv.style.display = 'none';
                    loadingContainer.style.display = 'none';
                    progressContainer.style.display = 'none';

                    // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œå‡å°‘è½®è¯¢é¢‘ç‡
                    if (window.statusCheckInterval) {
                        clearInterval(window.statusCheckInterval);
                        window.statusCheckInterval = null;
                    }

                    // å¦‚æœæ²¡æœ‰ä»»åŠ¡ï¼Œåˆ·æ–°å†å²è®°å½•ï¼ˆä½†ä¸å¼ºåˆ¶ï¼‰
                    // loadHistory(); // æ³¨é‡Šæ‰ï¼Œé¿å…é¢‘ç¹åˆ·æ–°
                    return;
                }
            }

            statusDiv.style.display = 'block';

            // æ›´æ–°è¯¦ç»†çŠ¶æ€ä¿¡æ¯
            if (data.current_stage) {
                currentStage.textContent = data.current_stage;
            }

            if (data.current_operation) {
                currentOperation.textContent = data.current_operation;
            }

            // å¤„ç†æ—¥å¿—ä¿¡æ¯
            if (data.recent_logs && data.recent_logs.length > 0) {
                // æ¸…é™¤ç°æœ‰æ—¥å¿—ï¼Œåªä¿ç•™æœ€æ–°çš„æ—¥å¿—
                if (window.lastLogTimestamp !== data.recent_logs[data.recent_logs.length - 1].timestamp) {
                    // æ·»åŠ æ–°æ—¥å¿—
                    for (var i = 0; i < data.recent_logs.length; i++) {
                        var log = data.recent_logs[i];
                        if (!window.loggedMessages || !window.loggedMessages[log.timestamp + log.message]) {
                            addLogEntry(translationLog, log.message, log.level);
                            if (!window.loggedMessages) window.loggedMessages = {};
                            window.loggedMessages[log.timestamp + log.message] = true;
                        }
                    }
                    window.lastLogTimestamp = data.recent_logs[data.recent_logs.length - 1].timestamp;
                }
            }

            if (data.status === 'waiting') {
                // é‡ç½®ç­‰å¾…è®¡æ•°å™¨ï¼Œä»»åŠ¡å·²æˆåŠŸæ·»åŠ åˆ°é˜Ÿåˆ—
                window.waitingCount = 0;

                messageSpan.textContent = 'æ‚¨çš„æ–‡ä»¶æ­£åœ¨æ’é˜Ÿä¸­ï¼Œå½“å‰ä½ç½®ï¼šç¬¬' + data.position + 'ä½';
                loadingContainer.style.display = 'none';
                progressContainer.style.display = 'block';
                currentStage.textContent = "æ’é˜Ÿç­‰å¾…ä¸­";
                currentOperation.textContent = "ä½ç½®: " + data.position;
                addLogEntry(translationLog, "ä»»åŠ¡å·²æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œç­‰å¾…å¤„ç†...", "info");
            }
            else if (data.status === 'processing') {
                messageSpan.textContent = 'æ‚¨çš„æ–‡ä»¶æ­£åœ¨ç¿»è¯‘ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...';
                loadingContainer.style.display = 'none';
                progressContainer.style.display = 'block';
                detailContent.classList.add('expanded');

                // æ›´æ–°è¯¦ç»†çŠ¶æ€
                currentStage.textContent = "ç¿»è¯‘å¤„ç†ä¸­";

                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                var currentSlide = data.current_slide || 0;
                var totalSlides = data.total_slides || 0;
                // ä¿®æ­£ï¼šå‰ç«¯æ˜¾ç¤ºæ—¶+1ï¼Œå› ä¸ºåç«¯ä¼ é€’çš„æ˜¯ä»0å¼€å§‹çš„ç´¢å¼•
                document.getElementById('currentSlide').textContent = currentSlide + 1;
                document.getElementById('totalSlides').textContent = totalSlides;
                var progress = data.progress || 0;
                document.getElementById('progressBarFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = progress + '%';

                // æ›´æ–°å½“å‰æ“ä½œä¿¡æ¯
                if (totalSlides > 0 && currentSlide >= 0) {
                    // ä¿®æ­£ï¼šæ˜¾ç¤ºæ—¶+1ï¼Œå› ä¸ºåç«¯ä¼ é€’çš„æ˜¯ä»0å¼€å§‹çš„ç´¢å¼•
                    currentOperation.textContent = `æ­£åœ¨ç¿»è¯‘ç¬¬ ${currentSlide + 1} é¡µï¼Œå…± ${totalSlides} é¡µ`;
                } else {
                    currentOperation.textContent = "æ­£åœ¨ç¿»è¯‘æ–‡æ¡£å†…å®¹";
                }

                // æ ¹æ®è¿›åº¦æ·»åŠ æ—¥å¿— - æ”¹ä¸ºæ¯æ¬¡éƒ½è®°å½•å½“å‰é¡µé¢è¿›åº¦
                if (currentSlide >= 0 && totalSlides > 0) {
                    // åªåœ¨é¡µé¢å˜åŒ–æ—¶è®°å½•æ—¥å¿—ï¼Œé¿å…é‡å¤
                    if (!window.lastLoggedSlide || window.lastLoggedSlide !== currentSlide) {
                        window.lastLoggedSlide = currentSlide;
                        // ä¿®æ­£ï¼šæ—¥å¿—æ˜¾ç¤ºæ—¶+1ï¼Œå› ä¸ºåç«¯ä¼ é€’çš„æ˜¯ä»0å¼€å§‹çš„ç´¢å¼•
                        addLogEntry(translationLog, `æ­£åœ¨ç¿»è¯‘ç¬¬ ${currentSlide + 1} é¡µï¼Œå…± ${totalSlides} é¡µ (${progress}%)`, "info");
                    }
                } else if (progress > 0 && progress % 20 === 0 && !window['logged_' + progress]) {
                    window['logged_' + progress] = true;
                    addLogEntry(translationLog, "å·²å®Œæˆ " + progress + "% çš„ç¿»è¯‘", "success");
                }
            }
            else if (data.status === 'completed') {
                // é‡ç½®ç¿»è¯‘çŠ¶æ€æ ‡å¿—
                window.isTranslationActive = false;
                window.waitingCount = 0;

                messageSpan.textContent = 'ç¿»è¯‘å·²å®Œæˆï¼';
                loadingContainer.style.display = 'none';
                progressContainer.style.display = 'block';
                detailContent.classList.add('expanded');

                // æ›´æ–°è¯¦ç»†çŠ¶æ€
                currentStage.textContent = "ç¿»è¯‘å·²å®Œæˆ";

                // æ˜¾ç¤ºæœ€ç»ˆçš„é¡µé¢ä¿¡æ¯
                var finalCurrentSlide = data.current_slide || data.total_slides || 0;
                var finalTotalSlides = data.total_slides || 0;
                if (finalTotalSlides > 0) {
                    document.getElementById('currentSlide').textContent = finalTotalSlides;
                    document.getElementById('totalSlides').textContent = finalTotalSlides;
                    currentOperation.textContent = `å·²å®Œæˆç¿»è¯‘ ${finalTotalSlides} é¡µ`;
                } else {
                    currentOperation.textContent = "å¤„ç†å®Œæ¯•";
                }

                document.getElementById('progressBarFill').style.width = '100%';
                document.getElementById('progressText').textContent = '100%';

                addLogEntry(translationLog, "ç¿»è¯‘ä»»åŠ¡å·²æˆåŠŸå®Œæˆï¼", "success");

                // ç¿»è¯‘å®Œæˆåå¼ºåˆ¶åˆ·æ–°å†å²è®°å½•
                loadHistory(true);
                setTimeout(function() {
                    statusDiv.style.display = 'none';
                    progressContainer.style.display = 'none';
                    // æ¸…é™¤å®šæ—¶å™¨
                    if (window.statusCheckInterval) {
                        clearInterval(window.statusCheckInterval);
                        window.statusCheckInterval = null;
                    }
                }, 5000);
            }
            else if (data.status === 'failed') {
                // é‡ç½®ç¿»è¯‘çŠ¶æ€æ ‡å¿—
                window.isTranslationActive = false;
                window.waitingCount = 0;

                messageSpan.textContent = 'ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•';
                statusDiv.className = 'alert alert-danger';
                loadingContainer.style.display = 'none';
                progressContainer.style.display = 'block';
                detailContent.classList.add('expanded');

                // æ›´æ–°è¯¦ç»†çŠ¶æ€
                currentStage.textContent = "ç¿»è¯‘å¤±è´¥";
                currentOperation.textContent = data.error || "æœªçŸ¥é”™è¯¯";

                addLogEntry(translationLog, "é”™è¯¯: " + (data.error || "ç¿»è¯‘è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"), "error");

                // æ¸…é™¤å®šæ—¶å™¨
                if (window.statusCheckInterval) {
                    clearInterval(window.statusCheckInterval);
                    window.statusCheckInterval = null;
                }

                // 5ç§’åéšè—è¿›åº¦å®¹å™¨
                setTimeout(function() {
                    statusDiv.style.display = 'none';
                    progressContainer.style.display = 'none';
                }, 5000);
            }
        })
        .catch(function(error) {
            console.error('Error checking task status:', error);
        });
}

// æ·»åŠ æ—¥å¿—æ¡ç›®çš„å‡½æ•°
function addLogEntry(logElement, message, type) {
    if (!type) type = "info";

    var now = new Date();
    var hours = now.getHours().toString();
    if (hours.length < 2) hours = '0' + hours;
    var minutes = now.getMinutes().toString();
    if (minutes.length < 2) minutes = '0' + minutes;
    var seconds = now.getSeconds().toString();
    if (seconds.length < 2) seconds = '0' + seconds;
    var timestamp = hours + ':' + minutes + ':' + seconds;

    var entry = document.createElement('div');
    entry.className = "log-entry " + type;

    var timestampSpan = document.createElement('span');
    timestampSpan.className = 'log-timestamp';
    timestampSpan.textContent = timestamp;

    entry.appendChild(timestampSpan);
    entry.appendChild(document.createTextNode(message));

    logElement.appendChild(entry);
    logElement.scrollTop = logElement.scrollHeight;
}

// åˆ‡æ¢è¯¦ç»†è§†å›¾çš„å‡½æ•°
function toggleDetailView() {
    var detailContent = document.getElementById('detailContent');
    var toggleBtn = document.getElementById('toggleDetailBtn');

    if (detailContent.classList.contains('expanded')) {
        detailContent.classList.remove('expanded');
        toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
    } else {
        detailContent.classList.add('expanded');
        toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
    }
}

// åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
document.addEventListener('DOMContentLoaded', () => {
    checkTaskStatus();

    // åˆå§‹åŒ–ç¿»è¯‘æ—¥å¿—
    const translationLog = document.getElementById('translationLog');
    if (translationLog) {
        addLogEntry(translationLog, "å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¸Šä¼ æ–‡ä»¶...", "info");
    }
});
</script>

<!-- æ·»åŠ  pptx.js å’Œ JSZip åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
{% endblock %}